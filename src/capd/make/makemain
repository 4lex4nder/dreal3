# This is a generic makefile for any single library module.
# Copyright (C) 2004-2010 by the CAPD Group.
# This is free software. No warranty. Consult 'license.txt' for details.
# Initial version created on October 26, 2004 by Pawel Pilarczyk.


# ===========================================================================
# Determine the target configuration (see the file 'makecfg' for details).
# ===========================================================================

include makecfg


# ===========================================================================
# Default module to compile (overridden in 'makefile').
# ===========================================================================

module = krak
MODULE = ${module}


# ===========================================================================
# Include external definitions.
# ===========================================================================

# define the home directory
HOME = ../

# include the compiler-dependent definitions
include config/${TARGET}

# include the definitions of paths
include makedirs

ifeq (1,${MULTIPRECISION}) 
COSTAM = tratata
COMPILE := ${COMPILE} -D__HAVE_MPFR__
SYSLIB  := ${SYSLIB} -lmpfr -lgmp
SYSLIBG := ${SYSLIBG} -lmpfr -lgmp 
endif

OBJ := ${OBJBASE}${LIBNAME}/

# ===========================================================================
# Main targets.
# ===========================================================================

# Determine the list of all the source files in the module.
SRCFILES = ${wildcard ${SRC}${MODULE}/*.cpp}
FILES = ${basename ${SRCFILES}}

# Determine the list of all the object files in the project.
OBJFILES = ${FILES:${SRC}%=${OBJ}%${OBJEXT}}

# Define the name of the library file corresponding to this module.
LIBRARY = ${LIB}lib${LIBNAME}${MODULE}${LIBEXT}

# The main targets: dependencies, objects, library.
.PHONY: ${MODULE}
${MODULE}: rundeps auto_deps/${LIBNAME}/${MODULE} objdir libdir ${OBJFILES} ${LIBRARY}

# The object base directory.
.PHONY: objbasedir
objbasedirfile = $(wildcard ${OBJ})
objbasedir:
ifeq (${objbasedirfile},)
	-${MKDIR} ${OBJ}
else
endif

# The object subdirectory of the module.
.PHONY: objdir
objdirfile = $(wildcard ${OBJ}${MODULE})
objdir: objbasedir
ifeq (${objdirfile},)
	-${MKDIR} ${OBJ}${MODULE}
else
endif

# The file containing all the dependencies depends on the source CPP files.
auto_deps/${LIBNAME}/${MODULE}: ${SRCFILES}

# Running "filedeps" to create the file containing all the dependencies.
.PHONY: rundeps
ifneq (${wildcard ${HOME}bin/filedeps*},)
rundeps:
	-${HOME}bin/filedeps --quiet -d -o auto_deps/${LIBNAME}/${MODULE} \
	${INC:%=-I%} -s${SRC} ${FILES:%=-l%}
auto_deps/${LIBNAME}/${MODULE}:
	-${HOME}bin/filedeps --quiet -d -o auto_deps/${LIBNAME}/${MODULE} \
	${INC:%=-I%} -s${SRC} ${FILES:%=-l%}
	-touch auto_deps/${LIBNAME}/${MODULE}
endif

# The library directory.
.PHONY: libdir
libdirfile = $(wildcard ${LIB})
libdir:
ifeq (${libdirfile},)
	-${MKDIR} ${LIB}
else
endif

# The library corresponding to this module.
${LIBRARY}: ${OBJFILES}
	${MAKELIB} ${LIBRARY} ${OBJFILES}
	${IDXLIB} ${LIBRARY}

#============================================================================
# Target for debugging makefile
#============================================================================
debug:
	@echo "TEST"
	@echo LIBNAME = ${LIBNAME}
	@echo SRC = ${SRC}
	@echo OBJ = ${OBJ}
	@echo COMPILE = ${COMPILE}
	@echo COSTAM = ${COSTAM}
	@echo  MAKEFLAGS = ${MAKEFLAGS}
	@echo MAKEOVERRIDES = ${MAKEOVERRIDES}
	@echo -----------------------------
	
# ===========================================================================
# Rules for MAKE on how to build object files.
# ===========================================================================

# prepare definitions for the dependencies in the external file
CCI = ${COMPILE} ${INC:%/=-I%} ${SYSINCL}
SRCLIB = ${SRC}
vpath %.h ${INC}
vpath %.hpp ${INC}
vpath %.hxx ${INC}

# include the dependencies of the files in this module
include auto_deps/${LIBNAME}/${MODULE}


# That's all, folks!

